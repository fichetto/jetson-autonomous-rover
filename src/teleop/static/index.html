<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLOVER - Stereo Video Stream</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: #1a1a2e;
            color: #eee;
            font-family: system-ui, -apple-system, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        h1 {
            margin-bottom: 10px;
            color: #00d4ff;
        }
        .status {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .status-item {
            background: #16213e;
            padding: 10px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4757;
        }
        .status-dot.connected {
            background: #2ed573;
        }
        .status-dot.connecting {
            background: #ffa502;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .video-container {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            max-width: 100%;
        }
        #videoElement {
            display: block;
            max-width: 100%;
            height: auto;
        }
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        button {
            background: #00d4ff;
            color: #1a1a2e;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        button:hover {
            background: #00a8cc;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        button.danger {
            background: #ff4757;
            color: white;
        }
        button.danger:hover {
            background: #ff3344;
        }
        .info {
            margin-top: 20px;
            background: #16213e;
            padding: 15px 25px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
        }
        .info table {
            width: 100%;
        }
        .info td {
            padding: 5px 10px;
        }
        .info td:first-child {
            color: #888;
        }
        .view-mode {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .view-mode label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 8px 16px;
            background: #16213e;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .view-mode label:hover {
            background: #1e3a5f;
        }
        .view-mode input:checked + span {
            color: #00d4ff;
        }
        #log {
            margin-top: 20px;
            background: #0d0d1a;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
            width: 100%;
            max-width: 800px;
        }
        .log-entry {
            margin: 2px 0;
            color: #888;
        }
        .log-entry.error { color: #ff4757; }
        .log-entry.success { color: #2ed573; }
        .log-entry.info { color: #00d4ff; }
    </style>
</head>
<body>
    <h1>ðŸ¤– CLOVER Stereo Stream</h1>

    <div class="status">
        <div class="status-item">
            <div class="status-dot" id="connectionDot"></div>
            <span id="connectionStatus">Disconnesso</span>
        </div>
        <div class="status-item">
            <span>ðŸ“Š</span>
            <span id="statsDisplay">--</span>
        </div>
    </div>

    <div class="video-container">
        <video id="videoElement" autoplay playsinline muted></video>
    </div>

    <div class="view-mode">
        <span>Vista:</span>
        <label>
            <input type="radio" name="viewMode" value="stereo" checked>
            <span>Stereo (SBS)</span>
        </label>
        <label>
            <input type="radio" name="viewMode" value="left">
            <span>Solo Sinistra</span>
        </label>
        <label>
            <input type="radio" name="viewMode" value="right">
            <span>Solo Destra</span>
        </label>
    </div>

    <div class="controls">
        <button id="connectBtn" onclick="connect()">Connetti</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnetti</button>
        <button id="fullscreenBtn" onclick="toggleFullscreen()">Fullscreen</button>
    </div>

    <div class="info">
        <table>
            <tr>
                <td>Server:</td>
                <td><input type="text" id="serverUrl" value="" style="background:#0d0d1a;border:1px solid #333;color:#eee;padding:5px 10px;border-radius:4px;width:250px;"></td>
            </tr>
            <tr>
                <td>Risoluzione:</td>
                <td id="resolution">--</td>
            </tr>
            <tr>
                <td>Codec:</td>
                <td id="codec">--</td>
            </tr>
        </table>
    </div>

    <div id="log"></div>

    <script>
        let pc = null;
        let statsInterval = null;

        // Auto-detect server URL
        const defaultPort = 8080;
        const serverInput = document.getElementById('serverUrl');
        serverInput.value = `http://${window.location.hostname || 'localhost'}:${defaultPort}`;

        function log(message, type = '') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(status, connected) {
            document.getElementById('connectionStatus').textContent = status;
            const dot = document.getElementById('connectionDot');
            dot.className = 'status-dot' + (connected ? ' connected' : status === 'Connessione...' ? ' connecting' : '');
        }

        async function connect() {
            if (pc) {
                log('GiÃ  connesso', 'error');
                return;
            }

            const serverUrl = serverInput.value;
            log(`Connessione a ${serverUrl}...`, 'info');
            updateStatus('Connessione...', false);

            document.getElementById('connectBtn').disabled = true;

            try {
                // Create peer connection
                pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });

                pc.ontrack = (event) => {
                    log('Track video ricevuto', 'success');
                    document.getElementById('videoElement').srcObject = event.streams[0];
                    updateResolutionInfo();
                };

                pc.oniceconnectionstatechange = () => {
                    log(`ICE state: ${pc.iceConnectionState}`);
                    if (pc.iceConnectionState === 'connected') {
                        updateStatus('Connesso', true);
                        document.getElementById('disconnectBtn').disabled = false;
                        startStats();
                    } else if (pc.iceConnectionState === 'disconnected' || pc.iceConnectionState === 'failed') {
                        updateStatus('Disconnesso', false);
                        stopStats();
                    }
                };

                // Add transceiver for receiving video
                pc.addTransceiver('video', { direction: 'recvonly' });

                // Create offer
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                // Wait for ICE gathering
                await new Promise((resolve) => {
                    if (pc.iceGatheringState === 'complete') {
                        resolve();
                    } else {
                        pc.onicegatheringstatechange = () => {
                            if (pc.iceGatheringState === 'complete') resolve();
                        };
                    }
                });

                // Send offer to server
                const response = await fetch(`${serverUrl}/offer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: pc.localDescription.type,
                        sdp: pc.localDescription.sdp
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const answer = await response.json();

                if (answer.error) {
                    throw new Error(answer.error);
                }

                await pc.setRemoteDescription(answer);
                log('Connessione WebRTC stabilita', 'success');

            } catch (error) {
                log(`Errore: ${error.message}`, 'error');
                updateStatus('Errore', false);
                document.getElementById('connectBtn').disabled = false;
                if (pc) {
                    pc.close();
                    pc = null;
                }
            }
        }

        function disconnect() {
            if (pc) {
                pc.close();
                pc = null;
            }
            document.getElementById('videoElement').srcObject = null;
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            updateStatus('Disconnesso', false);
            stopStats();
            log('Disconnesso', 'info');
        }

        function startStats() {
            statsInterval = setInterval(async () => {
                if (!pc) return;

                const stats = await pc.getStats();
                stats.forEach(report => {
                    if (report.type === 'inbound-rtp' && report.kind === 'video') {
                        const fps = report.framesPerSecond || '--';
                        const bytesReceived = report.bytesReceived || 0;
                        const kbps = Math.round((bytesReceived * 8) / 1000);
                        document.getElementById('statsDisplay').textContent =
                            `${fps} fps | ${kbps} kbps`;

                        if (report.decoderImplementation) {
                            document.getElementById('codec').textContent = report.decoderImplementation;
                        }
                    }
                });
            }, 1000);
        }

        function stopStats() {
            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
            }
            document.getElementById('statsDisplay').textContent = '--';
        }

        function updateResolutionInfo() {
            const video = document.getElementById('videoElement');
            video.onloadedmetadata = () => {
                document.getElementById('resolution').textContent =
                    `${video.videoWidth} x ${video.videoHeight}`;
            };
        }

        function toggleFullscreen() {
            const video = document.getElementById('videoElement');
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                video.requestFullscreen();
            }
        }

        // View mode handling
        document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const video = document.getElementById('videoElement');
                switch (e.target.value) {
                    case 'stereo':
                        video.style.clipPath = 'none';
                        video.style.transform = 'none';
                        break;
                    case 'left':
                        video.style.clipPath = 'inset(0 50% 0 0)';
                        video.style.transform = 'scale(2) translateX(25%)';
                        break;
                    case 'right':
                        video.style.clipPath = 'inset(0 0 0 50%)';
                        video.style.transform = 'scale(2) translateX(-25%)';
                        break;
                }
            });
        });

        // Auto-connect on load (optional)
        // window.onload = connect;
    </script>
</body>
</html>
